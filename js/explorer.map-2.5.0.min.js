EXPLORER.map=function(){var e={map:{},marker:{},cartodb_gmapsv3:{},drawing_manager:{},drawing_overlay:{},drawing_types:["geoellipse","georectangle","geopolygon"],filter:{},init:function(){this.addBoundsMethod();this.cartoDBinit();this.cartoDBsetBounds();this.cartoDBgenerateTile();EXPLORER.backbone.bindToFilterList("add",this.onAddFilter,this);EXPLORER.backbone.bindToFilterList("remove",this.removeFilterListener,this)},addBoundsMethod:function(){google.maps.Polygon.prototype.getBounds||(google.maps.Polygon.prototype.getBounds=
function(){var a=new google.maps.LatLngBounds;this.getPath().forEach(function(b,c){a.extend(b)});return a})},cartoDBinit:function(){CartoDBLayer.prototype._addWadus=function(){}},cartoDBsetBounds:function(){CartoDBLayer.prototype.setBounds=function(){}},onAddFilter:function(a){var b=a.get("searchableFieldName"),c,d;if(-1!==$.inArray(b,this.drawing_types)&&$.isEmptyObject(this.drawing_overlay)){this.filter=a;a=a.get("valueList");switch(b){case this.drawing_types[0]:d="circle";c=a[0].split(",");c={coords:[c[0],
c[1]],radius:parseInt(a[1],10)};break;case this.drawing_types[1]:d="rectangle";c=$.map(a.reverse(),function(a){return a.split(",")});c={coords:[[c[0],c[1]],[c[2],c[3]]]};break;case this.drawing_types[2]:d="polygon",c=$.map(a,function(a){return[a.split(",")]}),c={coords:c}}this.addDrawingOverlay({type:b,data:c});this.addDrawingOverlayListeners(d)}},removeFilterListener:function(a){-1!==$.inArray(a.get("searchableFieldName"),this.drawing_types)&&(this.removeDrawingOverlay(),this.filter={})},setBounds:function(a){var b=
this,c=!1,d;$.each(this.drawing_types,function(b,d){0<a.where({searchableFieldName:d}).length&&(c=!0)});0<a.length&&!c&&$.ajax({method:"GET",url:EXPLORER.settings.baseUrl+EXPLORER.settings.wsPath+"mapinfo?q\x3d"+encodeURIComponent(this.cartodb_gmapsv3.options.query||""),dataType:"json",success:function(a){0<a.extentMin[1]*a.extentMax[1]&&6E3>b.getDistanceAtEquator(a.extentMin[1],a.extentMax[1])?(d=new google.maps.LatLngBounds,d.extend(new google.maps.LatLng(a.extentMin[0],a.extentMin[1])),d.extend(new google.maps.LatLng(a.extentMax[0],
a.extentMax[1])),b.map.fitBounds(d)):(b.map.setZoom(2),b.map.setCenter(new google.maps.LatLng(35,-15)))}})},radians:function(a){return a*Math.PI/180},getDistanceAtEquator:function(a,b){var c=this.radians(b-a),c=Math.sin(c/2)*Math.sin(c/2);return 12756.274*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))},cartoDBgenerateTile:function(){CartoDBLayer.prototype._generateTileJson=function(){var a=this._generateUrl("tiler")+"/database/dataportal/table/"+this.options.table_name+"/{z}/{x}/{y}",b=a+".png",a=a+".grid.json",
c;this.options.query&&(c="sql\x3d"+encodeURIComponent(this.options.query.replace(/\{\{table_name\}\}/g,this.options.table_name)),b=this._addUrlData(b,c),a=this._addUrlData(a,c));this.options.tile_style&&(c="style\x3d"+encodeURIComponent(this.options.tile_style.replace(/\{\{table_name\}\}/g,this.options.table_name)),b=this._addUrlData(b,c),a=this._addUrlData(a,c));this.options.interactivity&&(c="interactivity\x3d"+encodeURIComponent(this.options.interactivity.replace(/ /g,"")),b=this._addUrlData(b,
c),a=this._addUrlData(a,c));return{blankImage:"../img/blank_tile.png",tilejson:"1.0.0",scheme:"xyz",name:this.options.table_name,tiles:[b],grids:[a],tiles_base:b,grids_base:a,opacity:this.options.opacity,formatter:function(a,b){return b}}}},setupMap:function(a){_.defaults(a,{mapCanvasId:"map_canvas",tilerDomain:"tiles.example.com",tilerProtocol:"http",tilerPort:80,mapQuery:"",mapCenter:[0,0],mapZoom:3});this.map=new google.maps.Map($("#"+a.mapCanvasId)[0],{center:new google.maps.LatLng(a.mapCenter[0],
a.mapCenter[1]),defaults:{editable:!0,strokeColor:"#0B0B09",fillColor:"#E7E7E7",fillOpacity:0.2},zoom:a.mapZoom,mapTypeId:google.maps.MapTypeId.TERRAIN,mapTypeControl:!0});this.marker=new google.maps.Marker({position:null,map:this.map});this.addDrawingManager();this.addDrawingListeners();this.cartodb_gmapsv3=new CartoDBLayer({map:this.map,marker:this.marker,table_name:"occurrence",interactivity:"auto_id",query:a.mapQuery,map_style:!1,infowindow:!0,auto_bound:!0,featureClick:this.onMapClick,tiler_domain:a.tilerDomain,
tiler_port:parseInt(a.tilerPort,10),tiler_protocol:a.tilerProtocol,featureOver:function(){this.map.setOptions({draggableCursor:"pointer"})},featureOut:function(){this.map.setOptions({draggableCursor:"default"})}})},onMapClick:function(a,b,c,d){a=EXPLORER.settings.baseUrl+"/"+EXPLORER.settings.locale+"/"+EXPLORER.i18n.getLanguageResource("url.occurrence-preview")+"/"+d.auto_id;this.marker.setPosition(b);$.get(a,"context\x3dmap").success(function(a){EXPLORER.preview.replacePreviewContent(a);EXPLORER.preview.show()}).error(function(a,
b,c){console.log(b+":"+c)})},addDrawingManager:function(){this.drawing_manager=new google.maps.drawing.DrawingManager({drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.CIRCLE,google.maps.drawing.OverlayType.RECTANGLE,google.maps.drawing.OverlayType.POLYGON]},circleOptions:this.map.defaults,rectangleOptions:this.map.defaults,polygonOptions:this.map.defaults});this.drawing_manager.setMap(this.map)},addDrawingListeners:function(){var a=
this;google.maps.event.addListener(this.drawing_manager,"drawingmode_changed",function(){a.drawing_manager.drawingMode&&(a.removeDrawingOverlay(),a.removeSpatialFilter(),a.cartodb_gmapsv3.setInteraction(!1))});google.maps.event.addListener(this.drawing_manager,"overlaycomplete",function(b){a.drawing_manager.setOptions({drawingMode:null});a.drawing_overlay=b.overlay;a.filter=a.addFilter(b.type);a.addDrawingOverlayListeners(b.type);a.cartodb_gmapsv3.setInteraction(!0)})},addDrawingOverlayListeners:function(a){var b=
this;switch(a){case "circle":$.each(["center","bounds"],function(a,d){google.maps.event.addListener(b.drawing_overlay,d+"_changed",function(){EXPLORER.backbone.updateActiveFilter(b.filter,{valueList:b.circleParameters()})})});break;case "rectangle":google.maps.event.addListener(b.drawing_overlay,"bounds_changed",function(){EXPLORER.backbone.updateActiveFilter(b.filter,{valueList:b.rectangleParameters()})});break;case "polygon":$.isEmptyObject(this.filter)||$.each(["insert","remove","set"],function(a,
d){google.maps.event.addListener(b.drawing_overlay.getPath(),d+"_at",function(){EXPLORER.backbone.updateActiveFilter(b.filter,{valueList:b.polygonParameters()})})})}},circleParameters:function(){var a=this.drawing_overlay;return[a.getCenter().lat()+","+a.getCenter().lng(),a.getRadius()]},rectangleParameters:function(){var a=this.drawing_overlay;return[a.getBounds().getNorthEast().lat()+","+a.getBounds().getNorthEast().lng(),a.getBounds().getSouthWest().lat()+","+a.getBounds().getSouthWest().lng()]},
polygonParameters:function(){var a=$.map(this.drawing_overlay.getPath().getArray(),function(a){return[a.lat()+","+a.lng()]});a.push(a[0]);return a},addDrawingOverlay:function(a){var b;switch(a.type){case this.drawing_types[0]:b=a.data.coords;b=new google.maps.LatLng(b[0],b[1]);a=$.extend({center:b,radius:a.data.radius},this.map.defaults);a=new google.maps.Circle(a);a.setMap(this.map);this.map.fitBounds(a.getBounds());this.drawing_overlay=a;break;case this.drawing_types[1]:a=a.data.coords;a=new google.maps.LatLngBounds(new google.maps.LatLng(a[0][0],
a[0][1]),new google.maps.LatLng(a[1][0],a[1][1]));a=$.extend({bounds:a},this.map.defaults);a=new google.maps.Rectangle(a);a.setMap(this.map);this.map.fitBounds(a.getBounds());this.drawing_overlay=a;break;case this.drawing_types[2]:a=a.data.coords,a=$.map(a,function(a){return new google.maps.LatLng(a[0],a[1])}),a=$.extend({paths:a},this.map.defaults),a=new google.maps.Polygon(a),a.setMap(this.map),this.map.fitBounds(a.getBounds()),this.drawing_overlay=a}},removeDrawingOverlay:function(){$.isEmptyObject(this.drawing_overlay)||
this.drawing_overlay.setMap(null);this.drawing_overlay={}},removeSpatialFilter:function(){$.each(this.drawing_types,function(a,b){EXPLORER.backbone.removeFilter({searchableFieldName:b})})},addFilter:function(a){var b={};switch(a){case "circle":b=EXPLORER.backbone.addActiveFilter({searchableFieldName:"geoellipse",valueList:this.circleParameters()});break;case "rectangle":b=EXPLORER.backbone.addActiveFilter({searchableFieldName:"georectangle",valueList:this.rectangleParameters()});break;case "polygon":3<
this.polygonParameters().length&&(b=EXPLORER.backbone.addActiveFilter({searchableFieldName:"geopolygon",valueList:this.polygonParameters()}))}return b}};return{init:function(){e.init()},setupMap:function(a){e.setupMap(a)},setBounds:function(a){e.setBounds(a)}}}();