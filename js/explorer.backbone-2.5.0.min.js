EXPLORER.backbone=function(){function q(a){a="operator."+a.toLowerCase();return EXPLORER.i18n.getLanguageResource(a)}function n(a){a="filter."+a.toLowerCase();return EXPLORER.i18n.getLanguageResource(a)}function r(a){return!_.isUndefined(a.type)&&-1!==a.type.indexOf("Boolean")}function s(a,b){var c=[],d;$.each(b,function(){if(r(a))d="filter.value."+this.toString().toLowerCase(),c.push(EXPLORER.i18n.getLanguageResource(d));else{if(_.contains(["WITHIN_RADIUS_GEO","INSIDE_ENVELOPE_GEO","INSIDE_POLYGON_GEO"],
a.searchableFieldTypeEnum))return"";c.push(this)}});return c.join()}function l(a){a=a||{};var b=a.searchableFieldId,c=a.searchableFieldName,d=a.valueList,f;b?f=h[b.toString()]:c&&(f=_.find(h,function(a){return a.searchableFieldName===c}));if(f&&(a.op||1===f.supportedOperator.length))return a=a.op||f.supportedOperator[0],b=JSON.stringify(d),d=new t({searchableFieldId:f.searchableFieldId,searchableFieldName:f.searchableFieldName,searchableFieldText:n(f.searchableFieldName),op:a,opText:q(a),valueList:d,
valueJSON:b,valueText:s(f,d)}),g.add(d),_.extend({},d)}function m(a){a.searchableFieldId&&(a.searchableFieldId=parseInt(a.searchableFieldId,10));return g.findWhere(a)}var w=_.template($("#filter_template_current").html()),x=Backbone.Model.extend({defaults:{searchableFieldId:-1,searchableFieldName:void 0,searchableFieldText:void 0}}),t=Backbone.Model.extend({defaults:{searchableFieldId:-1,searchableFieldName:void 0,searchableFieldText:void 0,groupId:-1,op:void 0,opText:void 0,valueList:[],valueJSON:void 0,
valueText:void 0}}),y=Backbone.Model.extend({defaults:{numberOfRecord:0}}),z=Backbone.Model.extend({defaults:{currentText:void 0,validate:!1}}),g=new (Backbone.Collection.extend({model:t})),e=new x,u=new y,k=new z,h,p,A=Backbone.View.extend({textValueTemplate:_.template($("#filter_template_text_input").html()),initialize:function(){this.setElement(this.textValueTemplate())},render:function(){return this},events:{"keyup input":"onTextTyped"},onTextTyped:function(a){var b;a&&(b=$(a.currentTarget).val(),
k.set({currentText:b,validate:13===a.keyCode}),40===a.keyCode&&$("#value_suggestions tr").keynavigator({cycle:!1,useCache:!1,activateOn:"focus",keys:{enter:function(a){$(a).trigger("click")}}}).first().focus())}}),B=Backbone.View.extend({suggestionValueTemplate:_.template($("#filter_template_suggestions").html()),cacheKeys:[],cacheMap:{},initialize:function(){k.bind("change:currentText",this.onTextChanged,this)},destroy:function(){k.unbind("change:currentText",this.onTextChanged);this.remove()},render:function(){this.setElement(this.suggestionValueTemplate());
this.onTextChanged(k);return this},events:{"click #value_suggestions tr":"createNewSuggestionFilter"},onTextChanged:function(a){var b={},c=e.get("searchableFieldId");a=a.get("currentText");var d=this;b.fieldId=e.get("searchableFieldId");a&&(b.curr=a,c+=a);this.cacheMap[c]?this.replaceTableCellContent(this.cacheMap[c]):$.get(EXPLORER.settings.baseUrl+EXPLORER.settings.wsPath+"livesearch",b).success(function(a){d.replaceTableCellContent(a);10===d.cacheKeys.length&&delete d.cacheMap[d.cacheKeys.shift()];
d.cacheKeys.push(c);d.cacheMap[c]=a}).error(function(a,c,b){alert(c)})},replaceTableCellContent:function(a){var b=0,c,d=this;$.each(a.rows,function(a,e){c=$("#value_suggestions tr:nth-child("+(a+1)+")",d.$el);c.find("td:nth-child(1)").html(e.value);c.find("td:nth-child(2)").html(e.occurrence_count);c.removeClass("hidden");c.attr("id",e.id);b=a+1});for(b+=1;10>=b;)c=$("#value_suggestions tr:nth-child("+b+")",d.$el),c.find("td:nth-child(1)").html(" "),c.find("td:nth-child(2)").html(" "),c.addClass("hidden"),
c.removeAttr("id"),b+=1},createNewSuggestionFilter:function(a){a=[$(a.currentTarget).find("td:nth-child(1)").text()];var b=JSON.stringify(a);g.find(function(a){return a.get("searchableFieldId")===parseInt(e.get("searchableFieldId"),10)&&a.get("valueJSON").toLowerCase()===b.toLowerCase()})||l({searchableFieldId:e.get("searchableFieldId"),op:"EQ",valueList:a})}}),C=Backbone.View.extend({partialTextTemplate:_.template($("#filter_template_partial_match").html()),initialize:function(){k.bind("change:currentText",
this.onTextChanged,this);k.bind("change:validate",this.onValidate,this);this.likeOp=_.find(h[e.get("searchableFieldId")].supportedOperator,function(a){return-1!==a.toLowerCase().search("^[s|e|c]like$")})},destroy:function(){k.unbind("change:currentText",this.onTextChanged);k.unbind("change:validate",this.onValidate);this.remove()},render:function(){this.setElement(this.partialTextTemplate({opText:q(this.likeOp)}));return this},events:{"click button":"createNewLikeFilter"},onTextChanged:function(a){$("#partial_match_value",
this.$el).text(a.get("currentText"))},onValidate:function(a){a.get("validate")&&this.createNewLikeFilter()},createNewLikeFilter:function(){var a=[k.get("currentText")],b=JSON.stringify(a);a&&0!==a.length&&(g.find(function(a){return a.get("searchableFieldId")===parseInt(e.get("searchableFieldId"),10)&&a.get("valueJSON").toLowerCase()===b.toLowerCase()})||l({searchableFieldId:e.get("searchableFieldId"),op:this.likeOp,valueList:a}))}}),D=Backbone.View.extend({textSelectionTemplate:_.template($("#filter_template_select").html()),
initialize:function(){},destroy:function(){this.remove()},render:function(){this.setElement(this.textSelectionTemplate());this.loadContent(e.get("searchableFieldId"));return this},events:{"click button":"createNewFilter"},loadContent:function(a){var b,c="";$.get(EXPLORER.settings.baseUrl+EXPLORER.settings.wsPath+"getpossiblevalues",{fieldId:a}).success(function(a){b=$("#value_select",this.$el);$.each(a,function(){c+='\x3coption value\x3d"'+this.value+'"\x3e'+this.value+"\x3c/option\x3e"});b.append(c)}).error(function(a,
b,c){alert(b)})},createNewFilter:function(){var a=[$("#value_select",this.$el).val()],b=JSON.stringify(a);a&&0!==a.length&&(m({searchableFieldId:e.get("searchableFieldId"),valueJSON:b})||l({searchableFieldId:e.get("searchableFieldId"),valueList:a}))}}),E=Backbone.View.extend({booleanValueTemplate:_.template($("#filter_template_boolean_value").html()),initialize:function(){},destroy:function(){this.remove()},render:function(){this.setElement(this.booleanValueTemplate({fieldText:e.get("searchableFieldText")}));
return this},events:{"click button":"createNewLikeFilter"},createNewLikeFilter:function(){var a=[$("input[name\x3dboolGroup]:checked",this.$el).val()];0!==a.length&&(m({searchableFieldId:e.get("searchableFieldId")})||l({searchableFieldId:e.get("searchableFieldId"),valueList:a}))}}),v=Backbone.View.extend({textValueTemplate:_.template($("#filter_template_single").html()),initialize:function(){this.setElement(this.textValueTemplate());var a=h[e.get("searchableFieldId")];this.supportSuggestion=a.supportSuggestion;
this.supportPartialMatch=a.supportPartialMatch;this.supportSelectionList=a.supportSelectionList;this.isBooleanFilter=r(a);this.booleanValueView=this.selectionValueView=this.partialTextValueView=this.textValueSuggestionView=void 0},render:function(){k.set("currentText","");this.supportPartialMatch&&(this.partialTextValueView=new C,this.$el.append(this.partialTextValueView.render().el));(this.supportPartialMatch||this.supportSuggestion)&&this.$el.append((new A).render().el);this.supportSuggestion&&
(this.textValueSuggestionView=new B,this.$el.append(this.textValueSuggestionView.render().el));this.supportSelectionList&&(this.selectionValueView=new D,this.$el.append(this.selectionValueView.render().el));this.isBooleanFilter&&(this.booleanValueView=new E,this.$el.append(this.booleanValueView.render().el));return this},destroy:function(){this.textValueSuggestionView&&(this.textValueSuggestionView.destroy(),this.textValueSuggestionView=void 0);this.partialTextValueView&&(this.partialTextValueView.destroy(),
this.partialTextValueView=void 0);this.selectionValueView&&(this.selectionValueView.destroy(),this.selectionValueView=void 0);this.booleanValueView&&(this.booleanValueView.destroy(),this.booleanValueView=void 0);this.remove()}}),F=Backbone.View.extend({dateIntervalTemplate:_.template($("#filter_template_date").html()),initialize:function(){},destroy:function(){},render:function(){this.setElement(this.dateIntervalTemplate());$("#date_end",this.el).hide();return this},events:{"click button":"createNewFilter",
"focus input[type\x3dtext]":"onFocus","blur input[type\x3dtext]":"onBlur","change input[type\x3dcheckbox]":"onSearchIntervalChanged"},onBlur:function(a){a=$(a.currentTarget);a.val()&&!EXPLORER.utils.isValidDateElement(a)?a.addClass("error"):a.removeClass("error")},onSearchIntervalChanged:function(){$("#date_end",this.$el).toggle();$(".label_single",this.$el).toggleClass("hidden");$(".label_range",this.$el).toggleClass("hidden")},createNewFilter:function(){var a=$.trim($("#date_start_y",this.$el).val()),
b=$.trim($("#date_start_m",this.$el).val()),c=$.trim($("#date_start_d",this.$el).val()),d=$("#interval",this.$el).is(":checked"),f=$.trim($("#date_end_y",this.$el).val()),g=$.trim($("#date_end_m",this.$el).val()),h=$.trim($("#date_end_d",this.$el).val());!EXPLORER.utils.isValidPartialDate(a,b,c)||d&&!EXPLORER.utils.isValidPartialDate(f,g,h)?alert(EXPLORER.i18n.getLanguageResource("control.invalid.date")):d&&!EXPLORER.utils.isValidDateInterval(a,b,c,f,g,h)?alert(EXPLORER.i18n.getLanguageResource("control.invalid.dateinterval")):
(a=[a+"-"+EXPLORER.utils.dateElementZeroPad(b)+"-"+EXPLORER.utils.dateElementZeroPad(c)],d&&a.push(f+"-"+EXPLORER.utils.dateElementZeroPad(g)+"-"+EXPLORER.utils.dateElementZeroPad(h)),f=JSON.stringify(a),m({searchableFieldId:e.get("searchableFieldId"),valueJSON:f})||l({searchableFieldId:e.get("searchableFieldId"),op:d?"BETWEEN":"EQ",valueList:a}))}}),G=Backbone.View.extend({minMaxValueTemplate:_.template($("#filter_template_minmax").html()),initialize:function(){},destroy:function(){},render:function(){this.setElement(this.minMaxValueTemplate());
$("#interval_max",this.el).hide();return this},events:{"click button":"createNewFilter","focus input[type\x3dtext]":"onFocus","blur input[type\x3dtext]":"onBlur","change input[type\x3dcheckbox]":"onSearchIntervalChanged"},onFocus:function(){},onBlur:function(a){a=$(a.currentTarget);var b=$.trim(a.val());EXPLORER.utils.isValidNumber(b)?a.removeClass("error"):a.addClass("error")},onSearchIntervalChanged:function(){$("#interval_max",this.$el).toggle();$(".label_single",this.$el).toggleClass("hidden");
$(".label_range",this.$el).toggleClass("hidden")},createNewFilter:function(){var a=$.trim($("#value_min",this.$el).val()),b=$("#interval",this.$el).is(":checked"),c=$.trim($("#value_max",this.$el).val());EXPLORER.utils.isValidNumber(a)?b&&!EXPLORER.utils.isValidNumber(c)?alert(EXPLORER.i18n.getLanguageResource("control.invalid.numberinterval")):(a=[a],b&&a.push(c),c=JSON.stringify(a),m({searchableFieldId:e.get("searchableFieldId"),valueJSON:c})||l({searchableFieldId:e.get("searchableFieldId"),op:b?
"BETWEEN":"EQ",valueList:a})):alert(EXPLORER.i18n.getLanguageResource("control.invalid.number"))}}),H=Backbone.View.extend({tagName:"li",className:"filter round",initialize:function(){},render:function(){$(this.el).html(this.model.get("searchableFieldText")+"\x3cul\x3e\x3c/ul\x3e");return this}}),I=Backbone.View.extend({tagName:"li",events:{"click span.delete":"remove"},initialize:function(){this.model.bind("remove",this.unrender,this);this.model.bind("change",this.render,this)},render:function(){$(this.el).html(w(this.model.toJSON()));
return this},unrender:function(){$(this.el).remove()},remove:function(){this.model.destroy()}}),J=Backbone.View.extend({initialize:function(){g.bind("add",this.addFilter,this);g.bind("remove",this.removeFilter,this);this.emptyFilterHtml=$("#filter_empty");this.nbOfFilter=this.filterCounter=0;this.filterGroupView={}},addFilter:function(a){0===this.nbOfFilter&&$("#filter_current").find(":first-child").remove();if(!this.filterGroupView[a.get("searchableFieldId")]){var b=new H({model:a});this.filterGroupView[a.get("searchableFieldId")]=
b.render().el;$("#filter_current").append(this.filterGroupView[a.get("searchableFieldId")])}this.filterCounter+=1;this.nbOfFilter+=1;a.set("groupId",this.filterCounter);b=new I({model:a});$("ul",this.filterGroupView[a.get("searchableFieldId")]).append(b.render().el)},removeFilter:function(a){0===g.where({searchableFieldId:a.get("searchableFieldId")}).length&&($(this.filterGroupView[a.get("searchableFieldId")]).remove(),delete this.filterGroupView[a.get("searchableFieldId")]);this.nbOfFilter-=1;0===
this.nbOfFilter&&$("#filter_current").append(this.emptyFilterHtml)},render:function(){return this}}),K=Backbone.View.extend({$key_select:void 0,initialize:function(){this.setElement(this.el);this.$key_select=$("#key_select",this.$el);e.bind("change:searchableFieldId",this.onFilterKeyChanged,this)},events:{"change #key_select":"onFilterFieldChanged"},onFilterKeyChanged:function(a){this.$key_select.val()!==a.get("searchableFieldId")&&this.$key_select.val(a.get("searchableFieldId"))},onFilterFieldChanged:function(){var a=
this.$key_select.val();e.set({searchableFieldId:a,searchableFieldName:h[a].searchableFieldName,searchableFieldText:n(h[a].searchableFieldName)})},render:function(){return this}}),L=Backbone.View.extend({lastComponent:void 0,initialize:function(){this.setElement("#filter_content");e.bind("change:searchableFieldId",this.onFilterKeyChanged,this)},events:{},onFilterKeyChanged:function(a){a=h[a.get("searchableFieldId")].searchableFieldTypeEnum;this.lastComponent&&this.lastComponent.destroy();this.lastComponent=
"SINGLE_VALUE"===a?new v:"START_END_DATE"===a?new F:"MIN_MAX_NUMBER"===a?new G:new v;this.$el.html(this.lastComponent.render().el)},render:function(){return this}}),M=Backbone.View.extend({downloadEmailTemplate:_.template($("#download_template_email").html()),events:{"click button":"onAskForDownload"},initialize:function(){this.setElement(this.el)},render:function(){this.$el.html(this.downloadEmailTemplate());this.$requestElement=$("#request",this.$el);this.$statusElement=$("#status",this.$el);return this},
onAskForDownload:function(){var a=this,b=$.trim($("#email",this.$el).val());EXPLORER.utils.isValidEmail(b)?(this.paramMap=[],_.extend(this.paramMap,p),this.paramMap.push({name:"e",value:b}),this.$requestElement.hide(),$.get(EXPLORER.settings.baseUrl+EXPLORER.settings.wsPath+"downloadresult",this.paramMap).success(function(b){"deferred"!==b.status&&a.$statusElement.html(b.error);a.$statusElement.show()}).error(function(b,d,e){a.showError()})):alert(EXPLORER.i18n.getLanguageResource("control.download.email.error"))}}),
N=Backbone.View.extend({initialize:function(){u.bind("change:numberOfRecord",this.onNumberOfRecordChanged,this)},render:function(){(new M({el:$("#download_content")})).render();return this},onNumberOfRecordChanged:function(){this.render()}}),O=Backbone.View.extend({displayMapTemplate:_.template($("#display_template_map").html()),events:{},initialize:function(){this.setElement(this.el)},render:function(){this.$el.html(this.displayMapTemplate())}}),P=Backbone.View.extend({displayTableTemplate:_.template($("#display_template_table").html()),
initialize:function(){this.setElement(this.el)},render:function(){this.$el.html(this.displayTableTemplate())}}),Q=Backbone.View.extend({initialize:function(){this.render()},render:function(){var a=$("form",$("#search"));("table"===$("input[name\x3dview]",a).val()?new P({el:$("#display")}):new O({el:$("#display")})).render();return this}});return{init:function(){new J;new L;new K({el:$("#filter_select")});new N;new Q},setNumberOfResult:function(a){u.set("numberOfRecord",a)},setAvailableSearchFields:function(a){h=
a},initActiveFilters:function(a,b,c){var d,f;for(f in a)a.hasOwnProperty(f)&&(l(a[f]),d=a[f].searchableFieldId.toString());p=$("form",$("#search")).serializeArray();d||(d=16);e.set({searchableFieldId:d,searchableFieldName:h[d].searchableFieldName,searchableFieldText:n(h[d].searchableFieldName)});"function"===typeof b&&b.call(c||this,g,this)},addActiveFilter:l,updateActiveFilter:function(a,b){var c=g.get(a.cid);if(c){var d=b.valueList||[],e=h[c.get("searchableFieldId").toString()],d={valueList:d,valueJSON:JSON.stringify(d),
valueText:s(e,d)};c.set(d)}},bindToFilterList:function(a,b,c){g.bind(a,b,c)},removeFilter:function(a){(a=g.findWhere(a))&&g.remove(a)},getInitialFilterParamMap:function(){return p}}}();